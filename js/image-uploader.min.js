let imageUploader = {
  init: (myclass) => {
    let createContainer = function () {
      let $container = $("<div>", { class: "image-uploader" });
      $("<input>", {
        type: "text",
        id: "imageNames",
        class: "d-none",
        name: "imageNames",
      }).appendTo($container);
      let $input = $("<input>", {
        type: "file",
        accept: ".jpg, .png, .jpeg",
        id: imageID,
        name: $(myclass).attr("id") + "[]",
        multiple: "",
      }).appendTo($container);
      if ($(myclass).attr("id") == "assets") {
        $input = $("<input>", {
          type: "file",
          accept: "*",
          id: imageID,
          name: $(myclass).attr("id") + "[]",
          multiple: "",
        }).appendTo($container);
      }
      $uploadedContainer = $("<div>", {
        class: "uploaded",
      }).appendTo($container);
      $textContainer = $("<div>", {
        class: "upload-text p-3",
      }).appendTo($container);
      $i = $(
        `<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" width="10rem" height="10rem" viewBox="0 0 24 24"><path d="M13 19v-4h3l-4-5l-4 5h3v4z" fill="var(--ec-primary-color)"/><path d="M7 19h2v-2H7c-1.654 0-3-1.346-3-3c0-1.404 1.199-2.756 2.673-3.015l.581-.102l.192-.558C8.149 8.274 9.895 7 12 7C9.244 5 6.85 6.611 5.757 9.15C3.609 9.792 2 11.82 2 14c0 2.757 2.243 5 5 5z" fill="var(--ec-primary-color)"/></svg>`
      ).appendTo($textContainer);
      $span = $("<span>", {
        text: "Drag & Drop files here or click to browse",
      }).appendTo($textContainer);
      $container.on("click", function (e) {
        prevent(e);
        $input.trigger("click");
      });
      $input.on("click", function (e) {
        e.stopPropagation();
      });
      $input.on("change", fileSelectHandler.bind($container));
      return $container;
    };
    let prevent = function (e) {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
    };
    let uploadImage = function (file, id) {
      var formdata = new FormData();
      formdata.append("image", file);
      $.ajax({
        url: `${_xUserData.baseURL}controllers/upload.php?auth=${
          _xUserData.auth
        }&username=${_xUserData.username}&id=${id}&type=${$(myclass).attr(
          "id"
        )}`,
        type: "POST",
        data: formdata,
        processData: false,
        contentType: false,
        success: function (response) {
          if (response.error.code === "#200") {
            let inputValue = $(`input[name='imageNames']`).val();
            $("input[name='imageNames']").val(
              inputValue + "," + response.data.id
            );
            $(`.uploaded-image[data-index='${id}']`).attr(
              "data-name",
              response.data.id
            );
            swal({
              title: "Success",
              text: response.data.image_url,
              icon: "success",
              confirmButtonText: "OK",
            });
            console.log(response);
          } else {
            alert("File not uploaded");
          }
        },
        error: function (error) {
          alert("File not uploaded");
        },
      });
    };
    let removeContainer = function ($buttonThis) {
      currentFiles--;
      let $container = $buttonThis.closest(".uploaded-image");
      let image = $container.data("image");
      let $index = $container.data("index");

      let inputValue = $(`input[name='imageNames']`).val();
      let newValue = inputValue.replace(`,${image}`, "");
      console.log(inputValue);
      $(`input[name='imageNames']`).val(newValue);

      if ($container.data("name")) {
        let name = $container.data("name");
        let arrIndex = previewedFiles.indexOf(name);
        if (arrIndex !== -1) {
          previewedFiles.splice(arrIndex, 1);
        }
      }
      $container.remove();
      if (currentFiles <= 0) {
        $(myclass + " .upload-text").css("display", "flex");
        $(myclass + " .image-uploader").removeClass("has-files");
      }
    };
    let createImg = function (file, id, name) {
      if (!previewedFiles.includes(name)) {
        let $container = $("<div>", {
            class: "uploaded-image",
          }),
          $wrapper = $("<div>", {
            class: "wrapper",
          }).appendTo($container),
          $button = $("<a>", {
            class: "delete-image",
            "data-id": id,
            "data-index": id,
          }).appendTo($container);
        $("<img>", { src: URL.createObjectURL(file) }).appendTo($wrapper);
        $(`<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59L7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12L5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z" fill="var(--ec-primary-color)"/></svg>`).appendTo($button);
        $container.attr("data-index", id);
        $container.attr("data-name", name);
        previewedFiles.push(name);
        console.log(previewedFiles);
        $container.on("click", function (e) {
          prevent(e);
        });
        $(myclass + " .upload-text").hide();
        $button.on("click", function (e) {
          prevent(e);
          removeContainer($(this));
        });
        uploadImage(file, id);
        return $container;
      } else {
        alert("This file Uploaded");
      }
    };
    let fileDragHover = function (e) {
      prevent(e);
      if (e.type === "dragover") {
        $(this).addClass("drag-over");
      } else {
        $(this).removeClass("drag-over");
      }
    };
    let fileSelectHandler = function (e) {
      prevent(e);let $container = $(this);
      $container.removeClass("drag-over");
      let files = e.target.files || e.originalEvent.dataTransfer.files;
      setPreview($container, files);
    };
    let setPreview = function ($container, files) {
      $container.addClass("has-files");
      let $uploadedContainer = $container.find(".uploaded"),
        $input = $container.find('input[type="file"]');
      $(files).each(function (i, file) {
        let acceptedTypes = ["jpg", "jpeg", "png"];
        dataTransfer.items.add(file);
        var fileExtension = file.name.substring(
          file.name.lastIndexOf(".") + 1,
          file.name.length
        );
        // Check For valid Extensions
        if (acceptedTypes.includes(fileExtension) || $(myclass).attr("id") == "assets") {
          // Check for 2MB Max size
          if (file.size < 2000000) {
            currentFiles++;
            $uploadedContainer.append(
              createImg(file, dataTransfer.items.length - 1, file.name)
            );
          } else {
            alert("This File is is Larger than out Limit");
          }
        } else {
          alert("File Format is not valid.(Only JPG, JPEG or PNG)");
        }
        if (currentFiles <= 0) {
          $(".image-uploader").removeClass("has-files");
        }
      });
      $input.prop("files", dataTransfer.files);
    };
    let random = function () {
      return Date.now() + Math.floor(Math.random() * 100 + 1);
    };
    const imageID = "images-" + random();
    let currentFiles = 0;
    let $uploadedContainer;
    let previewedFiles = [];
    let $container = createContainer();
    $(myclass).append($container);
    let dataTransfer = new DataTransfer();
    if (_xUserData[myclass]) {
      $images = _xUserData[myclass].split(",");
      for (let i = 0; i < $images.length; i++) {
        if ($images[i] !== "") {
          currentFiles++;
          let $container = $("<div>", {
              class: "uploaded-image",
            }),
            $wrapper = $("<div>", {
              class: "wrapper",
            }).appendTo($container),
            $button = $("<a>", {
              class: "delete-image",
              "data-id": $images[i],
              "data-index": i + 1,
            }).appendTo($container);
          $("<img>", {
            src: `${_xUserData.baseURL}/uploads/images/${$images[i]}`,
          }).appendTo($wrapper);
          $(
            `<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59L7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12L5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z" fill="var(--ec-primary-color)"/></svg>`
          ).appendTo($button);
          $container.attr("data-index", i + 1);
          $container.attr("data-name", $images[i]);
          previewedFiles.push($images[i]);
          console.log(previewedFiles);
          $container.on("click", function (e) {
            prevent(e);
          });
          $(myclass + " .upload-text").hide();
          $button.on("click", function (e) {
            prevent(e);
            removeContainer($(this));
          });
          $uploadedContainer.append($container);
        }
      }
    }

    // Add arrow move icons
    let createArrowIcons = function ($container) {
      let $arrowUp = $("<a>", {
        class: "move-image up",
      }).appendTo($container);
      $('<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="M24 0v24H0V0zM12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035c-.01-.004-.019-.001-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427c-.002-.01-.009-.017-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093c.012.004.023 0 .029-.008l.004-.014l-.034-.614c-.003-.012-.01-.02-.02-.022m-.715.002a.023.023 0 0 0-.027.006l-.006.014l-.034.614c0 .012.007.02.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="white" d="M10.94 7.94a1.5 1.5 0 0 1 2.12 0l5.658 5.656a1.5 1.5 0 1 1-2.122 2.121L12 11.122l-4.596 4.596a1.5 1.5 0 1 1-2.122-2.12z"/></g></svg>').appendTo($arrowUp);

      // $arrowUp.on("click", function (e) {
      //   prevent(e);
      //   moveImage($container, "up");
      // });

      // $arrowDown.on("click", function (e) {
      //   prevent(e);
      //   moveImage($container, "down");
      // });
        $container.on("click", ".move-image.up", function (e) {
          prevent(e);
          moveImage($container, "up");
        });
        
    };

    // Add CSS styles for arrow move icons
    let addArrowIconsStyles = function () {
      $("<style>")
       .prop("type", "text/css")
       .html(
          `.image-uploader.move-image { position: absolute; top: 50%; transform: translateY(-50%); width: 24px; height: 24px; background: none; border: none; cursor: pointer; }.image-uploader.move-image.up { left: -30px; }.image-uploader.move-image.down { right: -30px; }.image-uploader.move-image svg { fill: var(--ec-primary-color); }`
        )
       .appendTo("head");
    };

    // Move image container position
    let moveImage = function ($container, direction) {
      let $siblings = $container.siblings(".uploaded-image");
      let currentIndex = $container.index();

      if (direction === "up" && currentIndex > 0) {
        $container.insertBefore($siblings.eq(currentIndex - 1));
      } else if (direction === "down" && currentIndex < $siblings.length - 1) {
        $container.insertAfter($siblings.eq(currentIndex + 1));
      }
    };

    // Initialize arrow move icons
    addArrowIconsStyles();
    $container.find(".uploaded-image").each(function () {
      createArrowIcons($(this));
    });

    $container.on("dragover", fileDragHover.bind($container));
    $container.on("dragleave", fileDragHover.bind($container));
    $container.on("drop", fileSelectHandler.bind($container));
  },
};